const express = require('express');
const admin = require('firebase-admin');
const app = express();
app.use(express.json());


app.post('/api/v1/users/:id/redeem', async (req,res)=>{
const uid = req.params.id;
const {rewardId} = req.body;
const userRef = admin.firestore().collection('users').doc(uid);
const rewardRef = admin.firestore().collection('rewards').doc(rewardId);


await admin.firestore().runTransaction(async t =>{
const userDoc = await t.get(userRef);
const rewardDoc = await t.get(rewardRef);
if(!userDoc.exists || !rewardDoc.exists) throw new Error('not found');
const points = userDoc.data().points || 0;
const cost = rewardDoc.data().cost || 0;
if(points < cost) throw new Error('insufficient');
t.update(userRef, {points: points - cost});
t.set(admin.firestore().collection('userRewards').doc(), {
userId: uid, rewardId, redeemedAt: new Date().toISOString(), status: 'pending'
});
});
res.json({ok:true});
});
